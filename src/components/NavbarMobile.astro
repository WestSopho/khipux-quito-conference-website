---
import KhipuLogo from "../assets/khipu-logo.svg";
import Bars from "../assets/bars.svg";
import Close from "../assets/close.svg";
---

<!-- Mobile Navigation -->
<nav class="bg-khipu-black sticky top-0 z-50 py-4 md:hidden">
  <div class="content-container flex items-center">
    <div class="flex grow items-center justify-center gap-x-8">
      <KhipuLogo
        class="text-khipu-orange h-20 w-auto origin-center -rotate-90"
        role="img"
        aria-label="Khipu Logo"
      />
      <p class="text-khipu-white text-2xl font-bold text-nowrap">
        KHIPUx Quito
      </p>
    </div>
    <!-- Arrow Icon for the menu -->
    <div class="flex items-center justify-center">
      <button
        id="open-menu-button"
        class="text-khipu-white flex items-center justify-end p-2 font-bold"
      >
        <Bars
          class="text-khipu-orange h-8 w-auto"
          role="img"
          aria-label="Bars"
        />
      </button>
    </div>
  </div>
</nav>

<!-- Mobile Menu Overlay -->
<div
  id="mobile-menu"
  class="bg-khipu-black mobile-menu-overlay fixed inset-0 z-60 hidden max-h-screen p-8"
  data-state="closed"
>
  <!-- Container -->
  <div class="mobile-menu-panel flex flex-col justify-center gap-y-8">
    <!-- Close Button -->
    <button id="close-menu-button" class="flex items-center justify-end p-2">
      <Close
        class="text-khipu-white h-8 w-auto"
        role="img"
        aria-label="Close"
      />
    </button>
    <!-- Navigation Links -->
    <div
      class="text-khipu-white flex flex-col gap-y-4 text-end text-2xl font-bold uppercase"
    >
      <a
        href="#about"
        class="mobile-nav-link hover:text-khipu-orange transition-colors"
        >About</a
      >
      <a
        href="#speakers"
        class="mobile-nav-link hover:text-khipu-orange transition-colors"
        >Speakers</a
      >
      <a
        href="#schedule"
        class="mobile-nav-link hover:text-khipu-orange transition-colors"
        >Schedule</a
      >
      <a href="#register" class="mobile-nav-link text-khipu-orange"
        >Register Now!</a
      >
    </div>
    <!-- Big Khipu Logo -->
    <div class="flex items-center justify-center">
      <KhipuLogo
        class="text-khipu-white h-auto w-full"
        role="img"
        aria-label="Khipu Logo"
      />
    </div>
  </div>
</div>

<style>
  .mobile-menu-overlay {
    opacity: 0;
    pointer-events: none;
    transition: opacity 180ms ease;
  }

  .mobile-menu-panel {
    opacity: 0;
    transform: translateX(16px);
    transition:
      transform 220ms ease,
      opacity 180ms ease;
  }

  .mobile-menu-overlay[data-state="open"] {
    opacity: 1;
    pointer-events: auto;
  }

  .mobile-menu-overlay[data-state="open"] .mobile-menu-panel {
    opacity: 1;
    transform: translateX(0);
  }

  @media (prefers-reduced-motion: reduce) {
    .mobile-menu-overlay,
    .mobile-menu-panel {
      transition: none;
    }
  }
</style>

<script>
  const menu = document.querySelector<HTMLElement>("#mobile-menu");
  const panel = menu?.querySelector<HTMLElement>(".mobile-menu-panel") ?? null;
  const openBtn =
    document.querySelector<HTMLButtonElement>("#open-menu-button");
  const closeBtn =
    document.querySelector<HTMLButtonElement>("#close-menu-button");

  const OPEN_STATE = "open";
  const CLOSED_STATE = "closed";

  let closeTimeoutId: number | undefined;

  function openMenu() {
    if (!menu) return;
    if (closeTimeoutId) window.clearTimeout(closeTimeoutId);
    menu.classList.remove("hidden");
    // Next frame so the transition runs after `hidden` is removed.
    requestAnimationFrame(() => {
      menu.setAttribute("data-state", OPEN_STATE);
    });
  }

  function closeMenu() {
    if (!menu) return;
    if (closeTimeoutId) window.clearTimeout(closeTimeoutId);

    menu.setAttribute("data-state", CLOSED_STATE);

    const finish = () => {
      if (menu.getAttribute("data-state") === CLOSED_STATE) {
        menu.classList.add("hidden");
      }
    };

    const target = panel ?? menu;
    const onEnd = (e: Event) => {
      if (e.target !== target) return;
      target.removeEventListener("transitionend", onEnd);
      finish();
    };

    // If transitions are disabled (e.g. prefers-reduced-motion), `transitionend` may not fire.
    target.addEventListener("transitionend", onEnd);
    closeTimeoutId = window.setTimeout(() => {
      target.removeEventListener("transitionend", onEnd);
      finish();
    }, 320);
  }

  openBtn?.addEventListener("click", openMenu);
  closeBtn?.addEventListener("click", closeMenu);

  // Handle mobile nav link clicks - smooth scroll and close menu (respects reduced motion preference)
  const prefersReducedMotion = window.matchMedia(
    "(prefers-reduced-motion: reduce)"
  ).matches;

  const mobileNavLinks =
    document.querySelectorAll<HTMLAnchorElement>(".mobile-nav-link");
  mobileNavLinks.forEach((link) => {
    link.addEventListener("click", (e) => {
      const href = link.getAttribute("href");
      if (href?.startsWith("#")) {
        e.preventDefault();
        const target = document.querySelector(href);

        // Close the menu first
        closeMenu();

        // Scroll to target after a short delay to allow menu animation
        if (target) {
          setTimeout(() => {
            target.scrollIntoView({
              behavior: prefersReducedMotion ? "auto" : "smooth",
              block: "start",
            });
          }, 200);
        }
      }
    });
  });
</script>
